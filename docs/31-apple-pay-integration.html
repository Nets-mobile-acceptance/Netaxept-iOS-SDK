<!DOCTYPE html>
<html lang="en">
  <head>
    <title>3.1. Apple Pay Integration  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="3.1. Apple Pay Integration  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          Pia Docs
        </a>
         (68% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">Pia Reference</a>
      <img class="carat" src="img/carat.png" />
      3.1. Apple Pay Integration  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="0-getting-started.html">0. Getting started</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="11-basic-payment-flow.html">1.1. Basic payment flow</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="12-easy-one-click-payment-flow.html">1.2. Easy (one click) payment flow</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="13-recurring-payments.html">1.3. Recurring payments</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="14-payment-without-security-code.html">1.4. Payment Without Security Code</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="15-s-business-card.html">1.5. S-Business Card</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="16-co-branded-card-danish-merchants-only.html">1.6. Co-Branded card (Danish merchants only)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="2-saving-a-card.html">2. Saving a card</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="31-apple-pay-integration.html">3.1. Apple Pay Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="32-paypal-integration.html">3.2. PayPal Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="33-vipps-swish-mobilepay-integration.html">3.3. Vipps, Swish, MobilePay Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="34-finland---direct-bank-payment-via-paytrail.html">3.4. Finland - Direct bank payment (via Paytrail)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="4-ui-customization.html">4. UI Customization</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="51-error-codes-handling.html">5.1. Error Codes Handling</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="52-terminology.html">5.2. Terminology</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="53-faqs.html">5.3. FAQs</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="54-backend-tips.html">5.4. Backend Tips</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="6-limitations.html">6. Limitations</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="7-licenses.html">7. Licenses</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="8-changelog.html">8. Changelog</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="9-get-in-touch.html">9. Get in touch</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Categories.html">Categories</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Categories/NSError_28Wallets_29.html">NSError(Wallets)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CardDisplay.html">CardDisplay</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CardPayment.html">CardPayment</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CardPaymentProcess.html">CardPaymentProcess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CardRegistrationResponse.html">CardRegistrationResponse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CardStorage.html">CardStorage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/MerchantDetails.html">MerchantDetails</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIApplePayInfo.html">NPIApplePayInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIApplePayShippingInfo.html">NPIApplePayShippingInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIError.html">NPIError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIInterfaceConfiguration.html">NPIInterfaceConfiguration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIMerchantInfo.html">NPIMerchantInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIOrderInfo.html">NPIOrderInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPITokenCardInfo.html">NPITokenCardInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPITransactionInfo.html">NPITransactionInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PayPalPaymentProcess.html">PayPalPaymentProcess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PayPalRegistrationResponse.html">PayPalRegistrationResponse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PaymentProcess.html">PaymentProcess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PaytrailPaymentProcess.html">PaytrailPaymentProcess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PaytrailRegistrationResponse.html">PaytrailRegistrationResponse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PiaSDK.html">PiaSDK</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PiaSDKController.html">PiaSDKController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RegistrationResponse.html">RegistrationResponse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TokenizedCardExpressCheckout.html">TokenizedCardExpressCheckout</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TokenizedCardPayment.html">TokenizedCardPayment</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TokenizedCardPrompt.html">TokenizedCardPrompt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/TokenizedCardPromptConfirmation.html">TokenizedCardPromptConfirmation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes.html#/c:objc(cs)TokenizedCardPromptNone">TokenizedCardPromptNone</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WalletPaymentProcess.html">WalletPaymentProcess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WalletRegistrationResponse.html">WalletRegistrationResponse</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@NPIPiaSemanticVersionString">NPIPiaSemanticVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@NPIPiaTechnicalVersionString">NPIPiaTechnicalVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@PiaVersionNumber">PiaVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@PiaVersionString">PiaVersionString</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/Card.html">Card</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/CardScheme.html">CardScheme</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/PayButtonTextLabelOption.html">PayButtonTextLabelOption</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/PiALanguage.html">PiALanguage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/SchemeType.html">SchemeType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/Wallet.html">Wallet</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/WalletErrorCode.html">WalletErrorCode</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PaymentRegistering.html">PaymentRegistering</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PaymentRegistrationResult.html">PaymentRegistrationResult</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PiaSDKDelegate.html">PiaSDKDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PiaSDKTheme.html">PiaSDKTheme</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Type%20Definitions.html">Type Definitions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@CardError">CardError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@CardRegistrationCallback">CardRegistrationCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@CompletionCallback">CompletionCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentProcess.h@T@Currency">Currency</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@FailureCompletionCallback">FailureCompletionCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions/NPIErrorCode.html">NPIErrorCode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@PayPalRegistrationCallback">PayPalRegistrationCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@PaymentProcessCompletion">PaymentProcessCompletion</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@PaymentProcessFailure">PaymentProcessFailure</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@PaytrailRegistrationCallback">PaytrailRegistrationCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@RedirectURL">RedirectURL</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@TokenizableCardRegistrationCallback">TokenizableCardRegistrationCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@TokenizeCardForLaterUse">TokenizeCardForLaterUse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@TransactionCallback">TransactionCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@TransactionCompletion">TransactionCompletion</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@TransactionID">TransactionID</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:NSError+Wallets.h@T@WalletError">WalletError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@WalletFailureWithError">WalletFailureWithError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@WalletRedirectWithoutInterruption">WalletRedirectWithoutInterruption</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@WalletURL">WalletURL</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type%20Definitions.html#/c:PaymentRegistration.h@T@WalletURLCallback">WalletURLCallback</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Functions.html#/c:@F@isSBusinessInitiated">isSBusinessInitiated</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content top-matter">
            
            <h1 id='apple-pay-integration' class='heading'>Apple Pay Integration</h1>
<h2 id='prerequisite' class='heading'>Prerequisite</h2>

<ul>
<li>Create Apple Pay merchant ID.</li>
<li>Create a Payment Processing certificate.</li>
<li>Enable Apple Pay in Xcode.</li>
</ul>

<p>For instructions on these Apple Pay setups, see: </p>

<ul>
<li><a href="https://developer.apple.com/documentation/passkit/apple_pay/setting_up_apple_pay_requirements">Apple&rsquo;s documentation</a></li>
<li><a href="https://developer.apple.com/videos/play/tutorials/configuring-your-developer-account-for-apple-pay/">Video instructions by Apple</a></li>
<li><a href="https://developer.apple.com/apple-pay/sandbox-testing/">Apple Pay Sandbox Testing</a></li>
</ul>

<p>Apple servers use the certificate to encrypt payment data and Netaxept to decrypt and process payment.<br>
For further information about getting Netaxept CSR certificate, please refer to files below:</p>

<p><a href="Resources/ApplePayFlow.pptx">Netaxept - Apple Pay Payment Flow</a></p>

<p><a href="Resources/Netaxept_ApplePay_GetStartedGuide_EN_V0.45_Modified.pdf">Netaxept - Apple Pay Integration doc</a></p>
<h2 id='step-by-step-process' class='heading'>Step-by-step process</h2>

<ol>
<li>In your <a href="http://developer.apple.com/">Apple Developer Account</a> site,  get your Merchant ID (not your Netaxept Merchant ID).</li>
<li>In your <a href="https://epayment.nets.eu/admin">Netaxept ADMIN</a> site, get Apple Pay certificate following the instructions given.</li>
<li>In your project, enable Apple Pay capability with the correct Apple Pay Merchant ID you just created.</li>
<li>Navigate to your Apple Pay certificate obtained in step 1 and add the certificate to KeyChain (e.g. by double-clicking the file).</li>
<li>Use Pia SDK for Apple Pay according to the development guide shown below and in the PiaSample project.</li>
</ol>
<h2 id='apple-pay-checkout-overview' class='heading'>Apple Pay - Checkout Overview</h2>

<p><img src="./Resources/ApplePay.gif" alt="">  </p>
<h2 id='apple-pay-with-pia-sdk' class='heading'>Apple Pay with PiA SDK</h2>
<h3 id='step-1-check-apple-pay-support' class='heading'>Step 1: Check Apple Pay Support</h3>

<p>First, check if Apple Pay is supported by the device or that user is not restricted to use Apple Pay due to e.g. Parental control settings. 
The app should also check supported networks which user can make payments through. </p>
<pre class="highlight swift"><code><span class="c1">/// Apple's UI design guidelines encourage checking this condition </span>
<span class="c1">/// before displaying 'Buy with  Pay' button. </span>
<span class="k">guard</span> <span class="kt">PKPaymentAuthorizationViewController</span><span class="o">.</span><span class="nf">canMakePayments</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="c1">// Not supported on device / User is restricted</span>
<span class="p">}</span>

<span class="k">guard</span> <span class="kt">PKPaymentAuthorizationViewController</span><span class="o">.</span><span class="nf">canMakePayments</span><span class="p">(</span>
    <span class="nv">usingNetworks</span><span class="p">:</span> <span class="n">supportedApplePayNetworks</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">presentAppleWalletSetupEnquiry</span><span class="p">()</span>
        <span class="k">return</span>
<span class="p">}</span>
</code></pre>

<p>If the user does not have a supported card for the payment, the application may lead user to a different payment method or
open <em>Wallet</em> app so that the user can add a card in <em>Wallet</em> as follows:</p>
<pre class="highlight swift"><code>
<span class="c1">//  MARK: Apple Wallet Setup</span>

<span class="kd">func</span> <span class="nf">presentAppleWalletSetupEnquiry</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">alert</span> <span class="o">=</span> <span class="kt">UIAlertController</span><span class="p">(</span>
        <span class="nv">title</span><span class="p">:</span> <span class="o">.</span><span class="n">titleAppleWalletNotSetup</span><span class="p">,</span>
        <span class="nv">message</span><span class="p">:</span> <span class="o">.</span><span class="n">messageOpenAppleWalletApp</span><span class="p">,</span>
        <span class="nv">preferredStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">alert</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cancel</span> <span class="o">=</span> <span class="kt">UIAlertAction</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="o">.</span><span class="n">actionCancel</span><span class="p">,</span> <span class="nv">style</span><span class="p">:</span> <span class="o">.</span><span class="n">cancel</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">openWalletsApp</span> <span class="o">=</span> <span class="kt">UIAlertAction</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="o">.</span><span class="n">actionSetup</span><span class="p">,</span> <span class="nv">style</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">walletAppURL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"shoebox://url-scheme"</span><span class="p">),</span>
            <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">canOpenURL</span><span class="p">(</span><span class="n">walletAppURL</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">openURL</span><span class="p">(</span><span class="n">walletAppURL</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="nf">showAlert</span><span class="p">(</span>
                <span class="nv">title</span><span class="p">:</span> <span class="o">.</span><span class="n">titleCannotOpenAppleWallet</span><span class="p">,</span>
                <span class="nv">message</span><span class="p">:</span> <span class="o">.</span><span class="n">messageManuallyOpenAppleWallet</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">cancel</span><span class="p">,</span> <span class="n">openWalletsApp</span><span class="p">]</span><span class="o">.</span><span class="nf">forEach</span><span class="p">(</span><span class="n">alert</span><span class="o">.</span><span class="nf">addAction</span><span class="p">(</span><span class="nv">_</span><span class="p">:))</span>
    <span class="k">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="n">alert</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
<h3 id='step-2-present-apple-pay-payment-authorization-sheet' class='heading'>Step 2: Present Apple Pay Payment Authorization Sheet</h3>

<p>Start by creating a payment request (an instance of <code>PKPaymentRequest</code> from Apple&rsquo;s PassKit framework) using PiaSDK&rsquo;s helper. 
The helper covers all the mandatory parameters for a valid payment request. Based on the requirements of an application, 
the request can be modified to include more information. e.g. The sample app further modifies the request by including 
shipping address in the payment request. </p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">PiaSDK</span><span class="o">.</span><span class="nf">makeApplePayPaymentRequest</span><span class="p">(</span>
    <span class="nv">for</span><span class="p">:</span> <span class="n">supportedApplePayNetworks</span><span class="p">,</span>
    <span class="nv">countryCode</span><span class="p">:</span> <span class="s">"NO"</span><span class="p">,</span> <span class="c1">// Norway</span>
    <span class="nv">applePayMerchantID</span><span class="p">:</span> <span class="s">"ApplePay merchant ID"</span><span class="p">,</span>
    <span class="nv">merchantCapabilities</span><span class="p">:</span> <span class="o">.</span><span class="n">capability3DS</span><span class="p">,</span>
    <span class="nv">currencyCode</span><span class="p">:</span> <span class="s">"EUR"</span><span class="p">,</span>
    <span class="nv">summeryItems</span><span class="p">:</span> <span class="p">[</span>
        <span class="kt">PKPaymentSummaryItem</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"Item name"</span><span class="p">,</span> <span class="nv">amount</span><span class="p">:</span> <span class="n">itemCost</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">guard</span> <span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="kt">PKPaymentAuthorizationViewController</span><span class="p">(</span><span class="nv">paymentRequest</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="n">controller</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span> 
<span class="nf">present</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</code></pre>
<h3 id='step-3-implement-the-payment-authorization-delegate' class='heading'>Step 3: Implement The Payment Authorization Delegate</h3>

<p>The next step is to implement the two required delegate methods in <code>PKPaymentAuthorizationViewControllerDelegate</code>. 
Following user&rsquo;s approval to proceed with the payment, <code>didAuthorizePayment</code> delegate method is called with the payment 
object (an instance of <code>PKPayment</code>). Pia SDK provides a helper to obtain a token (UTF-8 string) parsing this object into the accepted 
format by Netaxept SOAP API. Pass this payment data to your merchant backend and essentially to Netaxept. </p>

<p>The sample app implements the delegate method as follows: </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">paymentAuthorizationViewController</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">PKPaymentAuthorizationViewController</span><span class="p">,</span>
    <span class="n">didAuthorizePayment</span> <span class="nv">payment</span><span class="p">:</span> <span class="kt">PKPayment</span><span class="p">,</span>
    <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">PKPaymentAuthorizationStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">let</span> <span class="nv">token</span> <span class="o">=</span> <span class="kt">PiaSDK</span><span class="o">.</span><span class="nf">netaxeptSOAPPaymentData</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

    <span class="n">api</span><span class="o">.</span><span class="nf">registerApplePay</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">orderDetails</span><span class="p">,</span> <span class="nv">token</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">transaction</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="nf">completion</span><span class="p">(</span><span class="kt">PKPaymentAuthorizationStatus</span><span class="o">.</span><span class="n">failure</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="nf">commitTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transactionId</span> <span class="p">,</span> <span class="nv">commitType</span><span class="p">:</span> <span class="o">.</span><span class="n">payment</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">transaction</span>
                <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="n">failure</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Following invoking of the completion block in <code>didAuthorizePayment</code> delegate method, <code>PassKit</code> notifies completion 
via <code>paymentAuthorizationViewControllerDidFinish</code> delegate call. The authorization payment sheet should be 
dismissed in this delegate call. </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">paymentAuthorizationViewControllerDidFinish</span><span class="p">(</span><span class="n">_</span> <span class="nv">controller</span><span class="p">:</span> <span class="kt">PKPaymentAuthorizationViewController</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">presentingViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">dismiss</span><span class="p">(</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Note: This delegate is called directly (without <code>didAuthorizePayment</code> preceding delegate call) if user <em>cancels</em> payment
in the payment authorization sheet. </p>

<p>(If the payment process contains shipping contact address, its necessary to implement the associated delegate methods 
in the protocol in order to adjust shipping cost accordingly)</p>
<h5 id='netaxept-backend-integration-request-body-apple-pay-payment-registration' class='heading'>Netaxept backend integration request body - Apple Pay payment registration:</h5>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"paymentData"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"paymentMethodActionList"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> 
        </span><span class="nl">"PaymentMethod"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"ApplePay"</span><span class="w"> 
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>The <em>paymentData</em> should contain th encrypted Payment Data from Apple pay of the following format: </p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"paymentData"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"data"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"signature"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"header"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"ephemeralPublicKey"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> 
            </span><span class="nl">"publicKeyHash"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"transactionId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"paymentMethod"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"displayName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"network"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w"> 
        </span><span class="nl">"type"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"transactionIdentifier"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Note: Netaxept backend integration tips can be found in <em>5.4 Backend Tips</em>,  <em>Request body - Apple Pay payment registration</em> <a href="./54-backend-tips.html#request-body-apple-pay-payment-registration">section</a></p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2022 <a class="link" href="https://nets.eu" target="_blank" rel="external">Nets</a>. All rights reserved. (Last updated: 2022-12-14)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.6</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
