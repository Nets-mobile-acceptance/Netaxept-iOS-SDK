<!DOCTYPE html>
<html lang="en">
  <head>
    <title>3.3. Vipps Integration  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="3.3. Vipps Integration  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          Pia Docs
        </a>
         (95% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">Pia Reference</a>
      <img class="carat" src="img/carat.png" />
      3.3. Vipps Integration  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="0-getting-started.html">0. Getting started</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="11-basic-payment-flow.html">1.1. Basic payment flow</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="12-easy-one-click-payment-flow.html">1.2. Easy (one click) payment flow</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="13-recurring-payments.html">1.3. Recurring payments</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="2-register-flow.html">2. Register flow</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="31-apple-pay-integration.html">3.1. Apple Pay Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="32-paypal-integration.html">3.2. PayPal Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="33-vipps-integration.html">3.3. Vipps Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="34-swish-m-commerce-integration.html">3.4. Swish m-commerce Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="4-ui-customization.html">4. UI Customization</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="51-error-codes-handling.html">5.1. Error Codes Handling</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="52-terminology.html">5.2. Terminology</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="53-faqs.html">5.3. FAQs</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="54-backend-tips.html">5.4. Backend Tips</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="6-licenses.html">6. Licenses</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="7-changelog.html">7. Changelog</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="8-get-in-touch.html">8. Get in touch</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIApplePayInfo.html">NPIApplePayInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIApplePayShippingInfo.html">NPIApplePayShippingInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIError.html">NPIError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIInterfaceConfiguration.html">NPIInterfaceConfiguration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIMerchantInfo.html">NPIMerchantInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPIOrderInfo.html">NPIOrderInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPITokenCardInfo.html">NPITokenCardInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/NPITransactionInfo.html">NPITransactionInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PiaSDK.html">PiaSDK</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PiaSDKController.html">PiaSDKController</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@NPIPiaSemanticVersionString">NPIPiaSemanticVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@NPIPiaTechnicalVersionString">NPIPiaTechnicalVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@PiaVersionNumber">PiaVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@PiaVersionString">PiaVersionString</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/PiALanguage.html">PiALanguage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/SchemeType.html">SchemeType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PiaSDKDelegate.html">PiaSDKDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SwishPaymentDelegate.html">SwishPaymentDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/VippsPaymentDelegate.html">VippsPaymentDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/WalletPaymentDelegate.html">WalletPaymentDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Type Definitions.html">Type Definitions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions/NPIErrorCode.html">NPIErrorCode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions.html#/c:PiaSDK.h@T@URLScheme">URLScheme</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions.html#/c:PiaSDK.h@T@VippsStatusCode">VippsStatusCode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions.html#/c:PiaSDK.h@T@WalletURL">WalletURL</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <h1 id='vipps-integration' class='heading'>Vipps Integration</h1>

<table><thead>
<tr>
<th style="text-align: center">Vipps Flow</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: center"><img src="./Resources/VippsFlow.gif" alt=""></td>
</tr>
</tbody></table>

<p>To initiate Vipps payment with <strong>Pia SDK</strong>, implement the <code><a href="Protocols/VippsPaymentDelegate.html">VippsPaymentDelegate</a></code> and trigger the process as follows:</p>
<pre class="highlight swift"><code><span class="c1">/// Initiating Vipps from a view controller that conforms to VippsPaymentDelegate.</span>
<span class="c1">/// The API returns false if Vipps app cannot be openned, e.g. uninstalled or missing</span>
<span class="c1">/// URL scheme in info.plist of your application. </span>
<span class="c1">/// - Note: The `sender` view controller is optionally passed to</span>
<span class="c1">///         display a transition view (an activity indicator)  </span>
<span class="c1">///         during the transition to and from Vipps app.</span>
<span class="k">guard</span> <span class="kt">PiaSDK</span><span class="o">.</span><span class="nf">initiateVipps</span><span class="p">(</span><span class="nv">fromSender</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Vipps is not installed, preferably lead user to other payment methods</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre>

<p><strong>Vipps App Detection</strong></p>

<p>The SDK checks if Vipps can be launched as the first step in the process preventing unnecessary payment registration. If Vipps app is not installed on user&rsquo;s device, we recommend leading user to other available payment methods.
The SDK throws <code>wallet app not installed</code> error in the corner case where user uninstalls Vipps app after payment has been registered with merchant backend.</p>

<p><strong>Note:</strong> In order for the PiA SDK to perform app detection, you need to add <code>vipps</code> under the <code>LSApplicationQueriesSchemes</code> key in your <strong>Info.plist</strong> file. If you skip this step, the PiA SDK will always return <code>wallet app cannot open</code> error even though you have the Vipps app installed on your device. </p>
<pre class="highlight plaintext"><code>&lt;key&gt;LSApplicationQueriesSchemes&lt;/key&gt;
&lt;array&gt;
    &lt;string&gt;vipps&lt;/string&gt;
&lt;/array&gt;
</code></pre>

<p>Here is the flow diagram for Vipps payment:</p>

<p><img src="./img/Vipps%20Payment%20Flow.png" alt="Vipps Payment Flow"></p>

<p><strong>Initializing a payment with Vipps:</strong></p>

<ul>
<li>The SDK will notify the app when it needs to register the payment via <code><a href="Protocols/VippsPaymentDelegate.html">VippsPaymentDelegate</a></code>. The app should register payment with merchant backend and return the wallet URL in the completion handler.</li>
<li>The <code>redirectUrl</code> has to be the merchant app scheme url followed by piasdk as the host <code>YOUR_APP_SCHEME_URL://piasdk</code>)</li>
<li>Provide customer&rsquo;s phone number in the following format: (Norwegian prefix): <code>phoneNumber = +4711111111</code>. Netaxept REST API expects URL encoded phone number. The encoding can take place in the client or merchant backend.<br></li>
<li>Vipps supports <strong>AUTH+CAPTURE</strong> process. If <strong>autoSale</strong> is set to <q>true</q>, Netaxept authorises and immediately captures the amount set in the <strong>REGISTER</strong> call. It is optional and default value is false (authorisation only and capture from the backend with additional process call).</li>
</ul>

<p>The following is an example of handling Vipps payment registration:</p>
<pre class="highlight swift"><code>
<span class="c1">// MARK: VippsPaymentDelegate - Vipps Registration</span>

    <span class="kd">func</span> <span class="nf">registerVippsPayment</span><span class="p">(</span><span class="n">_</span> <span class="nv">completionWithWalletURL</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">String</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a registration request body with order and payment details</span>
        <span class="c1">// The sample backend identifies Vipps with its method ID:</span>
        <span class="c1">// `PaymentMethodID(id: "Vipps", displayName: "Vipps", fee: 0)`</span>
        <span class="k">let</span> <span class="nv">requestBody</span><span class="p">:</span> <span class="kt">RegistrationRequest</span> <span class="c1">// see section: Backend Models (1.1)</span>

        <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">makeRegisterRequest</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">requestBody</span><span class="p">)</span> <span class="p">{</span> <span class="n">transaction</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">transaction</span> <span class="o">=</span> <span class="n">transaction</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="c1">// handle error</span>
            <span class="p">}</span>

            <span class="c1">// Grab the transaction ID, its used to later commit/rollback the registration</span>
            <span class="c1">// The SDK will callback the delegate with success/error result</span>
            <span class="c1">// Customer app is responsible for displaying the result to user</span>
            <span class="k">self</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">transaction</span>

            <span class="c1">// Notify Pia SDK with registration result</span>
            <span class="nf">completionWithWalletURL</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">walletUrl</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>

<p><strong>Launching Vipps App:</strong> </p>

<p>After registering the Vipps payment method and generating the <code>transaction Id</code> and <code>walletUrl</code> the PiA SDK will try to launch the Vipps app.</p>

<p><strong>Note:</strong> Vipps gives users 5 minutes to complete payment before the session expires. In case of a time-out, the merchant backend needs to make a Netaxept Query call to get the transaction status.</p>

<p>After the transaction is performed inside the Vipps application, Vipps redirects user to the merchant app via <code>open(_ url:options:completionHandler) -&gt; Bool</code> method of <code>UIApplication</code>. The merchant app needs to notify the SDK using the API <code>PiaSDK.applicationDidOpenFromRedirect(with: url, andOptions: options)</code>. </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">app</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">open</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplicationOpenURLOptionsKey</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:])</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>

    <span class="c1">// PiA SDK will return a boolean indicating if the redirect has been triggered by a payment app launched by PiA SDK.</span>
    <span class="k">return</span> <span class="kt">PiaSDK</span><span class="o">.</span><span class="nf">applicationDidOpenFromRedirect</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">andOptions</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The SDK will parse the redirect URL and notifies the delegate of successful, failed or interrupted result. The following code shows implementation of <code><a href="Protocols/VippsPaymentDelegate.html">VippsPaymentDelegate</a></code> in the sample app:</p>
<pre class="highlight swift"><code>
<span class="c1">// MARK: VippsPaymentDelegate - Results</span>

    <span class="kd">func</span> <span class="nf">walletPaymentDidSucceed</span><span class="p">(</span><span class="n">_</span> <span class="nv">transitionIndicatorView</span><span class="p">:</span> <span class="kt">UIView</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// Commit transaction</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">walletPaymentInterrupted</span><span class="p">(</span><span class="n">_</span> <span class="nv">transitionIndicatorView</span><span class="p">:</span> <span class="kt">UIView</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// User canceled/interrupted app-switch to Vipps app</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">vippsPaymentDidFail</span><span class="p">(</span><span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NPIError</span><span class="p">,</span> <span class="nv">vippsStatusCode</span><span class="p">:</span> <span class="kt">VippsStatusCode</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// Handle error</span>
    <span class="p">}</span>
</code></pre>

<p>Vipps application returns success and failure status codes. The Vipps status code is passed to the application in case of failed process.</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2019 <a class="link" href="https://nets.eu" target="_blank" rel="external">Nets</a>. All rights reserved. (Last updated: 2019-12-02)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
